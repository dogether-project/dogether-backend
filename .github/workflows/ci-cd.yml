name: Backend CI/CD

on:
  pull_request:
    types: [ opened, synchronize ]
    branches: [ dev, main ]
    paths:
      - 'src/**'
      - '.github/**'

jobs:
  test:
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    environment: test
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Set up jdk
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew\

      - name: Setup Firebase service key
        run: |
          mkdir -p src/main/resources/firebase
          echo ${{ secrets.FIREBASE_SERVICE_KEY_BASE64_ENCODE }} | base64 -d > src/main/resources/firebase/dogether-firebase-key-dev.json

      - name: Execute test
        # test íŒ¨í‚¤ì§€ í•˜ìœ„ application.yml ë¯¼ê° ì •ë³´ ì¶”ê°€
        env:
          DB_DRIVER: "org.h2.Driver"
          DB_URL: "jdbc:h2:mem:dogether;MODE=MYSQL"
          DB_USERNAME: "sa"
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          JWT_EXPIRE_TIME: ${{ secrets.JWT_EXPIRE_TIME }}
          APPLE_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_CLIENT_ID: ${{ secrets.APPLE_CLIENT_ID }}
          APPLE_PRIVATE_KEY: ${{ secrets.APPLE_PRIVATE_KEY }}
          AWS_S3_BUCKET_NAME: ${{ secrets.AWS_S3_BUCKET_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
        run: ./gradlew test --info

  check-deploy-decision:
    needs: [ test ]
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check-deploy-decision.outputs.should_deploy }}
      assignees: ${{ steps.check-deploy-decision.outputs.assignees }}
    steps:
      - name: Check deploy decision
        id: check-deploy-decision
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const hasDeployLabel = pr.data.labels.map(label => label.name).includes("deploy");
            let assignees = pr.data.assignees.map(user => user.login);
            if (assignees.length > 0) {
              assignees = assignees.join(', ');
            } else {
              assignees = context.payload.pull_request.user.login;
            }

            core.setOutput("should_deploy", hasDeployLabel ? "true" : "false");
            core.setOutput("assignees", assignees);

      - name: Explain deploy decision
        run: |
          if [[ "${{ steps.check-deploy-decision.outputs.should_deploy }}" == "true" ]]; then
            echo "ğŸšš deploy labelì´ ì¡´ì¬í•˜ë¯€ë¡œ ë°°í¬ ì‘ì—…ì„ ì§„í–‰í•©ë‹ˆë‹¤."
          else
            echo "âœ‹ deploy labelì´ ì—†ìœ¼ë¯€ë¡œ ë°°í¬ ì‘ì—…ì„ ìˆ˜í–‰í•˜ì§€ ì•Šê³  ì¢…ë£Œí•©ë‹ˆë‹¤."
          fi

  set-environment:
    needs: [ check-deploy-decision ]
    if: needs.check-deploy-decision.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-environment.outputs.environment }}
    steps:
      - name: Set environment
        id: set-environment
        run: |
          echo "Target Branch -> ${{ github.base_ref }}"
          echo "environment=dev" >> $GITHUB_OUTPUT

          if [[ ${{ github.base_ref }} == "main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          fi

      - name: Explain current environment
        run: echo "Current environment -> ${{ steps.set-environment.outputs.environment }}"

  image-build:
    needs: [ check-deploy-decision, set-environment ]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        environment: [ "${{ needs.set-environment.outputs.environment }}" ]
    environment: ${{ matrix.environment }}
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Set up jdk
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew\

      - name: Setup Firebase service key
        run: |
          mkdir -p src/main/resources/firebase
          echo ${{ secrets.FIREBASE_SERVICE_KEY_BASE64_ENCODE }} | base64 -d > src/main/resources/firebase/dogether-firebase-key-${{ matrix.environment }}.json

      - name: Build with gradle
        run: ./gradlew bootJar -Pspring.profiles.active=${{ matrix.environment }} --info

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          mask-password: 'true'

      - name: Docker build & push
        run: |
          docker build --build-arg SPRINGBOOT_APP_PROFILE=${{ matrix.environment }} --platform linux/arm64 -f docker/Dockerfile --tag ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }} .
          docker push ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}

  deploy:
    needs: [ check-deploy-decision, set-environment, image-build ]
    runs-on: dogether-be-dev-ec2-runner
    strategy:
      matrix:
        environment: [ "${{ needs.set-environment.outputs.environment }}" ]
    environment: ${{ matrix.environment }}
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create .env file
        run: |
          cd ~/project
          cat <<EOF > .env
          # springboot-app environment
          SPRINGBOOT_APP_IMAGE_REPOSITORY=${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}
          SPRINGBOOT_APP_IMAGE_TAG=${{ github.sha }}
          
          # mysql environment
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_URL=${{ secrets.DB_URL }}
          
          # jwt environment
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          JWT_EXPIRE_TIME=${{ secrets.JWT_EXPIRE_TIME }}
          
          # apple oauth environment
          APPLE_KEY_ID=${{ secrets.APPLE_KEY_ID }}
          APPLE_TEAM_ID=${{ secrets.APPLE_TEAM_ID }}
          APPLE_CLIENT_ID=${{ secrets.APPLE_CLIENT_ID }}
          APPLE_PRIVATE_KEY=${{ secrets.APPLE_PRIVATE_KEY }}
          
          # AWS
          AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}
          EOF

      - name: Execute new application
        run: |
          cd ~/project
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | sudo docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
          sudo docker-compose stop springboot-app
          sudo docker-compose rm -f springboot-app
          sudo docker images --filter=reference="*/springboot-app-${{ matrix.environment }}:*" -q | xargs -r sudo docker rmi -f
          sudo docker-compose up -d springboot-app
          sudo rm -rf .env

      - name: Check deploy result
        id: check-deploy-result
        run: |
          echo "ğŸ” ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ì‹¤í–‰ í™•ì¸ì¤‘..."
          for i in {1..30}; do
            response=$(curl -sf http://localhost:8080/api/health-check || true)
            if [[ "$response" == *"OK"* ]]; then
              echo "ğŸº ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ì‹¤í–‰ í™•ì¸!"
              echo "deploy_result=success" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "â³ ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ëŒ€ê¸°... ($i/30)"
              sleep 1
            fi
          done
          echo "âŒ ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ..."
          echo "deploy_result=fail" >> $GITHUB_OUTPUT
          exit 1

      - name: Send deploy success notification
        if: steps.check-deploy-result.outputs.deploy_result == 'success'
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-color: 3066993
          embed-title: "ğŸ‰ BE ë°°í¬ ì„±ê³µ ì•Œë¦¼! (${{ matrix.environment }})"
          embed-description: |
            ì˜¤ëŠ˜ì€ ìƒë§¥ ã… ğŸº

            - ì‘ì—…ì : ${{ needs.check-deploy-decision.outputs.assignees }}
            - PR : ${{ github.event.pull_request.html_url }}
            - Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Send deploy fail notification
        if: failure() || steps.check-deploy-result.outputs.deploy_result == 'fail'
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-color: 15158332
          embed-title: "âŒ BE ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼ã…œ (${{ matrix.environment }})"
          embed-description: |
            ì§‘ì— ë³´ë‚´ì¤˜... ğŸŒ›

            - ì‘ì—…ì : ${{ needs.check-deploy-decision.outputs.assignees }}
            - PR : ${{ github.event.pull_request.html_url }}
            - Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
